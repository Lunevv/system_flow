#!/bin/bash

# ะกะบัะธะฟั ะดะปั ะฑััััะพะณะพ ะดะตะฟะปะพั ะฝะฐ ัะตัะฒะตั
# ะัะฟะพะปัะทะพะฒะฐะฝะธะต: ./deploy.sh [message]

PROJECT_DIR="$HOME/system_flow"
COMMIT_MESSAGE="${1:-Update from local development}"

echo "๐ ะะตะฟะปะพะน ะฝะฐ ัะตัะฒะตั..."

# ะัะพะฒะตััะตะผ ััะพ ะผั ะฒ ะฟัะฐะฒะธะปัะฝะพะน ะดะธัะตะบัะพัะธะธ
if [ ! -f "$PROJECT_DIR/package.json" ]; then
  echo "โ ะัะธะฑะบะฐ: ะะต ะฝะฐะนะดะตะฝะฐ ะดะธัะตะบัะพัะธั ะฟัะพะตะบัะฐ"
  echo "ะฃะฑะตะดะธัะตัั ััะพ ะฒั ะฝะฐัะพะดะธัะตัั ะฒ ~/system_flow"
  exit 1
fi

# ะกะพะทะดะฐะตะผ ะฑะตะบะฐะฟ ะฟะตัะตะด ะพะฑะฝะพะฒะปะตะฝะธะตะผ
echo "๐พ ะกะพะทะดะฐะตะผ ะฑะตะบะฐะฟ ัะตะบััะตะน ะฒะตััะธะธ..."
cd "$PROJECT_DIR"
./backup-server.sh > /dev/null 2>&1

# ะะฑะฝะพะฒะปัะตะผ ะธะท Git
echo "๐ฅ ะะฑะฝะพะฒะปัะตะผ ะฟัะพะตะบั ะธะท Git..."
git pull

# ะฃััะฐะฝะฐะฒะปะธะฒะฐะตะผ ะทะฐะฒะธัะธะผะพััะธ
echo "๐ฆ ะัะพะฒะตััะตะผ ะทะฐะฒะธัะธะผะพััะธ..."
npm install

# ะะตัะตัะพะฑะธัะฐะตะผ ะฟัะพะตะบั
echo "๐จ ะะตัะตัะพะฑะธัะฐะตะผ ะฟัะพะตะบั..."
npm run build

# ะะตัะตะทะฐะฟััะบะฐะตะผ ัะตัะฒะตั
echo "๐ ะะตัะตะทะฐะฟััะบะฐะตะผ ัะตัะฒะตั..."
./stop-server.sh
sleep 2
./start-server.sh

echo ""
echo "โ ะะตะฟะปะพะน ะทะฐะฒะตััะตะฝ!"
echo ""
echo "๐ ะัะพะฒะตัััะต ัะฐะฑะพัั:"
echo "   http://46.149.69.102"
echo ""
echo "๐ ะัะพะฒะตัััะต ะปะพะณะธ:"
echo "   tail -f logs/proxy.log"
echo "   tail -f logs/frontend.log"
